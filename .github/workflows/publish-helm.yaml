name: Publish Helm Chart

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Package Helm Chart
        run: |
          helm package helm/cloudflare-zero-trust-operator -d .helm-charts

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Update Helm Repository
        run: |
          cp .helm-charts/*.tgz gh-pages/
          helm repo index gh-pages --url https://veleh.github.io/cloudflare-zero-trust-operator
          
          # Create index.html
          cat > gh-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Cloudflare Zero Trust Operator - Helm Charts</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #f38020; }
              code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
            </style>
          </head>
          <body>
            <h1>üîê Cloudflare Zero Trust Operator - Helm Charts</h1>
            <p>Kubernetes operator for managing Cloudflare Zero Trust settings</p>
            
            <h2>üì¶ Installation</h2>
            <pre>helm repo add veleh https://veleh.github.io/cloudflare-zero-trust-operator
              helm repo update
              helm install cloudflare-zero-trust-operator veleh/cloudflare-zero-trust-operator</pre>
            
            <h2>üìö Documentation</h2>
            <p>For more information, visit the <a href="https://github.com/veleh/cloudflare-zero-trust-operator">GitHub repository</a>.</p>
            
            <h2>üìã Available Charts</h2>
            <ul id="charts"></ul>
            
            <script>
              fetch('index.yaml')
                .then(r => r.text())
                .then(yaml => {
                  const entries = yaml.match(/- name: (.*?)\n.*?version: (.*?)\n/g) || [];
                  const ul = document.getElementById('charts');
                  entries.forEach(entry => {
                    const name = entry.match(/name: (.*)/)[1];
                    const version = entry.match(/version: (.*)/)[1];
                    ul.innerHTML += '<li><strong>' + name + '</strong> - version ' + version + '</li>';
                  });
                });
            </script>
          </body>
          </html>
          EOF

      - name: Publish to GitHub Pages
        run: |
          cd gh-pages
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish Helm chart for ${{ github.ref_name }}"
            git push origin gh-pages
          fi
